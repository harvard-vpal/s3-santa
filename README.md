# s3-santa
Data request user manager for AWS S3

This python package provides functionality for creating IAM user accounts and corresponding user folders in an S3 bucket on AWS, and storing generated IAM key pairs in a user store (e.g. Google Sheet or CSV file).

## Getting started

### Dependencies

Required dependencies
* boto3

Optional data store dependencies (required if using Google Sheet user store)
* gspread
* oauth2client

Optional runtime dependencies:
* Docker
* Docker Compose

### Installation
Install locally
```
git clone https://github.com/kunanit/s3-santa
pip install ./s3-santa
```

### AWS Setup
Some AWS resources should be set up manually before using s3santa:
* Create an S3 bucket
* Create an IAM group
* Add policy to IAM group (see example policy `example_group_policy.json`; replace the S3 bucket name with your own)

### Other configuration
Usage requires populating the following environment variables:
* `S3_BUCKET`
* `IAM_GROUP`
* `GOOGLE_KEYFILE`
* `GOOGLE_SPREADSHEET_ID`

The following additional config variables may be optional depending on your environment:
* `HOST_GOOGLE_KEYFILE`
* `AWS_ACCESS_KEY_ID`
* `AWS_SECRET_ACCESS_KEY`

See `.env.example` for example values of these variables. If running with docker environment, these variable values can be set in a `.env` file.


## Usage

### CLI usage
The provided script `santa.py` runs a command line interface for s3santa functions. 

Then you can run santa.py from the command line as follows:
```
# create user by username
python santa.py create-user --user {USER}

# create user with autogenerated username
python santa.py create-user
# Asks for confirmation after generating user name 
# >>> Create user '{USER}'? [y/n]

# deliver file to user
python santa.py deliver --file {FILE} --user {USER}

```

Running with docker environment:
```
# build the image first
docker-compose build

# drun_app passes arguments to docker-compose run app
# and auto-populates AWS environment variables from host AWS config file
./drun_app python santa.py {arguments}
```

### s3santa package usage
```
from s3santa.cli import SantaCli
from s3santa.santa import Santa

# choose the user store type to use
from s3santa.user_store import GoogleSpreadsheet

# fill these in
S3_BUCKET = '' # name of s3 bucket to use
IAM_GROUP = '' # name of iam group policy
GOOGLE_KEYFILE = '' # location of google service account keyfile
GOOGLE_SPREADSHEET_ID = '' # google spreadsheet id (can be found from url)

# define the user storage to use with santa
user_store = GoogleSpreadsheet(
    spreadsheet_id=GOOGLE_SPREADSHEET_ID,
    google_keyfile=GOOGLE_KEYFILE,
)

# create santa object
santa = Santa(S3_BUCKET, IAM_GROUP, user_store)

#### Example actions ####
# create user by specifying user name
santa.create_user('mynewuser')

# create user with an autogenerated name
santa.create_user()

# deliver local file to user folder
santa.deliver(file, user)
```

